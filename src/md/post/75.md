---
layout: ./src/jade/_post.jade
page_type: 'post'
page_datetime: '2015-12-05T10:00:00'
page_id: '75'
page_tag:
  - 'Advent Calendar'
  - 'CSS'
page_description: 'ブラウザの@importの解釈の違いを利用したCSSハック回顧会場'
page_title: '@importハックの回顧'
---
“昔々あるところに……。” [CSS昔話Advent Calendar](http://www.adventar.org/calendars/723)の4日目。

CSSの@importルールはCSS内で違うCSSファイルをインクルードすることができる機能だが、ブラウザによって宣言の解釈が異なっている時代があった。

- Windows IE4.xとMac IE4.0は@importルールでurl()を使わないと解釈できない
- Mac IE4.5は@importルールでファイルパス指定をシングルクォーテーションで記述しないと解釈できない

<pre data-language="css"><code>/* Windows IE4.xとMac IE4.0はurl()でないと解釈できない */
@import "/css/file1.css" /* 無効 */
@import url("/css/file2.css") /* 有効 */

/* Mac IE4.5ではシングルクォーテーションでないと解釈できない */
@import url("/css/file1.css") /* 無効 */
@import url('/css/file2.css') /* 有効 */</code></pre>

IE4やMac IE4.5でも@importを正常に機能させるにはurl()かつシングルクォーテーションを使えばよいわけだ。

TODO:@importの仕様をチェックする  
TODO:IE4が解釈できない記述パターンを調べ直す

主要ブラウザがIE6の時代がきてもシェアの低くなっている前述のブラウザにも対応させる必要があった。ニュースサイトなどがそれにあたる。僕が関わっていたサイトでは、@importの解釈の違いを利用してブラウザごとに違うリソースを読み込ませる手法が取り入れられていた。

用意するCSSファイルは3つ。

- すべてのブラウザに読み込ませるCSS
- IE4では読み込まれず、Mac IE4.5とIE5以上で読み込まれるCSS
- Mac IE4.5では読み込まれず、IE5以上で読み込まれるCSS

「すべてのブラウザに読み込ませるCSS」は、HTML側でlink要素で指定する。

<pre data-language="html"><code>&lt;link rel="stylesheet" href="/css/common.css" media="screen"&gt;</code></pre>

「IE4では読み込まれず、Mac IE4.5とIE5以上で読み込まれるCSS」はcommon.css内の@importルールで制御する。

<pre data-language="css"><code>/* common.css */
/* url()でないのでIE4で読み込まれない */
@import "/css/common_macie4_5.css";</code></pre>

「Mac IE4.5では読み込まれず、IE5以上で読み込まれるCSS」はcommon_macie4_5.css内で同じく@importルールで制御する。

<pre data-language="css"><code>/* common_macie4_5.css */
/* シングルクォーテーションでないのでMac IE4.5で読み込まれない */
@import url("/css/common_main.css");</code></pre>

これを適用すると各ブラウザで読み込まれるCSSファイルは

- IE4 -> common.css
- Mac IE4.5 -> common.css + common_macie4_5.css
- IE5 -> common.css + common_macie4_5.css + common_main.css

となり、link要素と2段階の@importによって擬似的にブラウザ判定をしてリソースを制御するというわけだ。

## なぜ@importハックが必要だったか

さまざまな要因があったように記憶しているが、当時のレガシーブラウザ向け記述のソース上での分離よりも、レガシーブラウザで**スタイルを当てない**ことが最大の目的だったと思う。僕が関わっていたそのサイトでは主要ブラウザをメインターゲットにCSSを書いていたが、IE4ではそれらのスタイルを読み込ませると表示が大きく崩れてまともに閲覧できない状況にあった。IE4だけに適用させるハックは当時は発見されておらず（おそらく今でも）、セレクタやプロパティーのハックで対応することは不可能だった。そこで、IE4ではCSSをほぼ当てない状態で閲覧可能にする解に至った。

当時主要ブラウザであったIE6向けのスタイル宣言では、背景画像指定などで多数の画像ファイルを読み込んでいた。スプライト画像の利用がほとんどなかった頃なので、IE4を使っているプラットフォームでは当然それらのリソースファイルのロードも負荷がかかる。そのうえ表示が崩れるわ文字が見切れるわで観れたものではない。であればいっそ、CSSファイルを読み込ませずに軽量なUAのデフォルトスタイルで見せよう、というわけだ。

この思想は@hilokiさんがブログに書いていたUniversal IE6 CSSという提案と同じものだ。僕はUniversal IE6 CSSについては知らなかったのだけど、あのブログ記事を読んでとても懐かしく感じたし、@importハックを使ってIE4向けにスタイルを当てないという選択はやはり理にかなっていたのだなと嬉しくなった。

<aside>もちろん僕はその頃は新人だので、その選択をしたのはコーディングリーダーであり僕ではない</aside>

## @importハックのミソ

CSSの@importルールは他の@ルールよりも前に、かつ@charsetルールの後に記述しなければならないと仕様で決まっている。@importルールを記述するとそのインポートファイルのスタイル宣言が先にブラウザに読み込まれるので、インポートする順番と逆の順でスタイル宣言が読み込まれる。

1. common_main.cssのスタイル宣言
2. common_macie4_5.cssのスタイル宣言
3. common.cssのスタイル宣言

IE4ではcommon.cssのスタイル宣言しか読まれない。なので、common_main.cssよりもcommon_macie4_5.css、common_macie4_5.cssよりもcommon.cssに書いたスタイル宣言がカスケーディングによって上書きされる。IE6向けのスタイル宣言がIE4向けのスタイル宣言で上書きされては本末転倒なので、セレクタの詳細度によって制御する。これが@importハックのミソだ。

僕が関わっていたサイトでもcommon.cssにはごく少量のスタイル宣言が書かれていて、そのセレクタはclassやIDを使わないタイプセレクタだった。common_macie4_5.cssではもう少し装飾を加えていたと思う。common_main.cssではclassセレクタやIDセレクタで書かれていたので、IE6ではcommon.cssやcommon_macie4_5.cssのスタイル宣言の影響を受けない仕組みだった。

チームに入って最初にこの手法を見た時はその仕組みも詳細度のこともほとんど理解していなかったのだけど、今で言うreset.cssに近い内容がcommon.cssにもcommon_main.cssにも書かれているのをコーディングリーダーに質問した時、丁寧に教えてくれたことをよく覚えている。より多くの人に情報を届けるべく当時できる最大限のブラウザ対応を使命にしていた人だった。僕より先に辞職したが、今もどこかでウェブ制作に関わっているといいなと勝手に思う。

---

この手法はinvalidな記述でないにしろ、ブラウザの実装差異を利用したCSSハックと言って差し支えないだろう。CSSハックは悪しき習慣だとする認識が浸透して久しいが、これが導く結果やUniversal IE6 CSSなどのアプローチはなんらかの形で残って欲しいなと思っている。新しいUniversal ** CSS現れた時、僕はまた「より多くの人に情報を届ける」という、ウェブサイトの命題とも言えるそれを思い出すのだろう。そうしてレガシーとモダンの間を行ったり来たりしながら、ウェブの進化と共に歩いていきたい。

いい話っぽく終われた。5日目は[@kojika17](http://www.adventar.org/users/3679)さんです。